version: '3.8'

# Example Docker Compose configuration demonstrating BuildKit secret management
# This shows how to use secrets during build time with Docker Compose

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.secrets-example
      target: production
      # Secrets are mounted during build but NOT persisted in the image
      secrets:
        - pip_token
      args:
        BUILDKIT_INLINE_CACHE: 1
    image: backend:latest
    environment:
      - ENVIRONMENT=production
    ports:
      - "8000:8000"
    depends_on:
      postgres:
        condition: service_healthy

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.secrets-example
      target: production
      # Multiple secrets can be provided
      secrets:
        - npm_token
        - api_key
      args:
        BUILDKIT_INLINE_CACHE: 1
    image: frontend:latest
    ports:
      - "80:80"
    depends_on:
      - backend

  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: myapp
      POSTGRES_USER: myapp
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-devpassword}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U myapp"]
      interval: 5s
      timeout: 3s
      retries: 5

volumes:
  postgres-data:

# Secret definitions
# Secrets can be sourced from files or environment variables
secrets:
  # Option 1: From file (recommended for local development)
  pip_token:
    file: ./secrets/pip_token.txt
  
  # Option 2: From environment variable (recommended for CI/CD)
  npm_token:
    environment: NPM_TOKEN
  
  # Option 3: From file with fallback
  api_key:
    file: ./secrets/api_key.txt

# Usage instructions:
#
# 1. Create secrets directory and files:
#    mkdir -p secrets
#    echo "your-pip-token" > secrets/pip_token.txt
#    echo "your-api-key" > secrets/api_key.txt
#    chmod 600 secrets/*
#
# 2. Set environment variables (if using environment option):
#    export NPM_TOKEN="your-npm-token"
#
# 3. Build with secrets:
#    docker-compose -f docker-compose.secrets-example.yml build
#
# 4. Verify secrets not in images:
#    docker history backend:latest
#    docker history frontend:latest
#
# 5. Run services:
#    docker-compose -f docker-compose.secrets-example.yml up
#
# Note: Add secrets/ directory to .gitignore to prevent committing secrets!
