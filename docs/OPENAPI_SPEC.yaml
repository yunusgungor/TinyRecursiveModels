openapi: 3.0.3
info:
  title: Trendyol Gift Recommendation API
  description: |
    Trendyol Gift Recommendation API, kullanÄ±cÄ± profillerine gÃ¶re kiÅŸiselleÅŸtirilmiÅŸ 
    hediye Ã¶nerileri sunan bir REST API'dir. API, eÄŸitilmiÅŸ TinyRecursiveModels (TRM) 
    modelini kullanarak gerÃ§ek zamanlÄ± Ã¶neriler Ã¼retir ve Trendyol'dan Ã¼rÃ¼n verilerini Ã§eker.
    
    ## Features
    - ðŸŽ¯ AI-powered personalized recommendations
    - ðŸ’° Budget-aware suggestions
    - â­ Review analysis
    - ðŸ“Š Price comparison
    - ðŸ”„ Caching for fast responses
    - ðŸ§  **NEW: Explainable AI with reasoning traces**
    
    ## Reasoning Enhancement (NEW)
    
    API artÄ±k modelin karar verme sÃ¼recini aÃ§Ä±klayan detaylÄ± reasoning (akÄ±l yÃ¼rÃ¼tme) 
    bilgileri sunmaktadÄ±r. Bu Ã¶zellik sayesinde:
    
    - **Tool Selection Reasoning**: Hangi analiz araÃ§larÄ±nÄ±n neden seÃ§ildiÄŸini Ã¶ÄŸrenin
    - **Category Matching**: Kategorilerin kullanÄ±cÄ± profiliyle nasÄ±l eÅŸleÅŸtirildiÄŸini gÃ¶rÃ¼n
    - **Attention Weights**: Modelin hangi Ã¶zelliklere odaklandÄ±ÄŸÄ±nÄ± anlayÄ±n
    - **Thinking Steps**: Modelin adÄ±m adÄ±m dÃ¼ÅŸÃ¼nme sÃ¼recini takip edin
    - **Confidence Explanation**: GÃ¼ven skorunun nedenlerini Ã¶ÄŸrenin
    
    ### Reasoning Levels
    
    ÃœÃ§ farklÄ± detay seviyesi mevcuttur:
    
    1. **basic**: Sadece hediye seviyesinde aÃ§Ä±klamalar
       - Performans etkisi: ~%5
       - KullanÄ±m: HÄ±zlÄ± yanÄ±t gereken durumlar
    
    2. **detailed** (varsayÄ±lan): Tool seÃ§imi + kategori eÅŸleÅŸtirme + hediye aÃ§Ä±klamalarÄ±
       - Performans etkisi: ~%8
       - KullanÄ±m: Ã‡oÄŸu kullanÄ±m senaryosu iÃ§in Ã¶nerilen
    
    3. **full**: TÃ¼m reasoning bileÅŸenleri (attention weights + thinking steps dahil)
       - Performans etkisi: ~%10
       - KullanÄ±m: Debug, analiz ve geliÅŸtirme
    
    ### Usage Examples
    
    ```bash
    # No reasoning
    curl -X POST "http://localhost:8000/api/v1/recommendations?include_reasoning=false"
    
    # Basic reasoning (default)
    curl -X POST "http://localhost:8000/api/v1/recommendations"
    
    # Detailed reasoning
    curl -X POST "http://localhost:8000/api/v1/recommendations?reasoning_level=detailed"
    
    # Full reasoning
    curl -X POST "http://localhost:8000/api/v1/recommendations?reasoning_level=full"
    ```
    
    ## Rate Limiting
    - 10 requests per minute per IP
    - Headers: X-RateLimit-Limit, X-RateLimit-Remaining, X-RateLimit-Reset
    
    ## Authentication
    Currently public API. JWT authentication will be added in future versions.
  version: 1.0.0
  contact:
    name: API Support
    email: support@example.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:8000
    description: Development server
  - url: https://staging-api.example.com
    description: Staging server
  - url: https://api.example.com
    description: Production server

tags:
  - name: recommendations
    description: Gift recommendation operations
  - name: health
    description: Health check and monitoring
  - name: tools
    description: Tool statistics and information
  - name: metrics
    description: Prometheus metrics

paths:
  /api/v1/recommendations:
    post:
      tags:
        - recommendations
      summary: Get gift recommendations
      description: |
        Generate personalized gift recommendations based on user profile.
        
        The endpoint:
        1. Validates user profile
        2. Checks cache for existing recommendations
        3. Fetches available gifts from Trendyol
        4. Runs model inference
        5. Executes analysis tools
        6. Returns ranked recommendations
        
        ## Reasoning Enhancement
        
        The API supports optional reasoning traces that explain the model's decision-making process:
        
        - **include_reasoning**: Enable/disable reasoning generation (default: true)
        - **reasoning_level**: Control detail level (basic, detailed, full)
        
        ### Reasoning Levels
        
        - **basic**: Only gift-level reasoning (why this gift was recommended)
        - **detailed**: Gift reasoning + tool selection + category matching
        - **full**: Everything including attention weights and thinking steps
        
        ### Performance Impact
        
        - Basic reasoning: ~5% overhead
        - Detailed reasoning: ~8% overhead
        - Full reasoning: ~10% overhead
      operationId: getRecommendations
      parameters:
        - name: include_reasoning
          in: query
          description: |
            Whether to include reasoning trace in the response.
            
            - `true`: Include reasoning based on reasoning_level
            - `false`: No reasoning, only recommendations
            
            Default: `true` (basic reasoning)
          required: false
          schema:
            type: boolean
            default: true
          example: true
        - name: reasoning_level
          in: query
          description: |
            Level of reasoning detail to include.
            
            - `basic`: Gift-level reasoning only
            - `detailed`: Gift reasoning + tool selection + category matching
            - `full`: Complete trace with attention weights and thinking steps
            
            Only applies when include_reasoning=true.
            
            Default: `detailed`
          required: false
          schema:
            type: string
            enum: [basic, detailed, full]
            default: detailed
          example: detailed
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RecommendationRequest'
            examples:
              basic:
                summary: Basic recommendation request
                value:
                  user_profile:
                    age: 35
                    hobbies: ["cooking", "gardening"]
                    relationship: "mother"
                    budget: 500.0
                    occasion: "birthday"
                    personality_traits: ["practical"]
                  max_recommendations: 5
                  use_cache: true
              detailed:
                summary: Detailed request with multiple traits
                value:
                  user_profile:
                    age: 28
                    hobbies: ["technology", "gaming", "photography"]
                    relationship: "friend"
                    budget: 1500.0
                    occasion: "graduation"
                    personality_traits: ["tech-savvy", "creative", "minimalist"]
                  max_recommendations: 10
                  use_cache: false
      responses:
        '200':
          description: Successful response with recommendations
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnhancedRecommendationResponse'
              examples:
                no_reasoning:
                  summary: Response without reasoning (include_reasoning=false)
                  value:
                    recommendations:
                      - gift:
                          id: "12345"
                          name: "Premium Coffee Set"
                          category: "Kitchen & Dining"
                          price: 299.99
                          rating: 4.5
                          image_url: "https://cdn.trendyol.com/example.jpg"
                          trendyol_url: "https://www.trendyol.com/product/12345"
                          description: "High-quality coffee set"
                          tags: ["coffee", "kitchen", "gift"]
                          age_suitability: [25, 65]
                          occasion_fit: ["birthday", "anniversary"]
                          in_stock: true
                        confidence_score: 0.92
                        reasoning: []
                        tool_insights: {}
                        rank: 1
                    tool_results: {}
                    reasoning_trace: null
                    inference_time: 1.15
                    cache_hit: false
                basic_reasoning:
                  summary: Response with basic reasoning (reasoning_level=basic)
                  value:
                    recommendations:
                      - gift:
                          id: "12345"
                          name: "Premium Coffee Set"
                          category: "Kitchen & Dining"
                          price: 299.99
                          rating: 4.5
                          image_url: "https://cdn.trendyol.com/example.jpg"
                          trendyol_url: "https://www.trendyol.com/product/12345"
                          description: "High-quality coffee set"
                          tags: ["coffee", "kitchen", "gift"]
                          age_suitability: [25, 65]
                          occasion_fit: ["birthday", "anniversary"]
                          in_stock: true
                        confidence_score: 0.92
                        reasoning:
                          - "Perfect match for your hobbies: cooking"
                          - "Great value: Only 60% of your budget"
                          - "Highly rated: 4.5/5.0 stars"
                          - "Age-appropriate for 35 years old"
                          - "Perfect for birthday"
                        tool_insights:
                          price_comparison:
                            best_price: 299.99
                            average_price: 350.0
                            savings_percentage: 14.3
                        rank: 1
                    tool_results: {}
                    reasoning_trace: null
                    inference_time: 1.20
                    cache_hit: false
                detailed_reasoning:
                  summary: Response with detailed reasoning (reasoning_level=detailed)
                  value:
                    recommendations:
                      - gift:
                          id: "12345"
                          name: "Premium Coffee Set"
                          category: "Kitchen & Dining"
                          price: 299.99
                          rating: 4.5
                          image_url: "https://cdn.trendyol.com/example.jpg"
                          trendyol_url: "https://www.trendyol.com/product/12345"
                          description: "High-quality coffee set"
                          tags: ["coffee", "kitchen", "gift"]
                          age_suitability: [25, 65]
                          occasion_fit: ["birthday", "anniversary"]
                          in_stock: true
                        confidence_score: 0.92
                        reasoning:
                          - "Perfect match for your hobbies: cooking"
                          - "Great value: Only 60% of your budget"
                          - "Highly rated: 4.5/5.0 stars"
                        tool_insights: {}
                        rank: 1
                    tool_results: {}
                    reasoning_trace:
                      tool_selection:
                        - name: "price_comparison"
                          selected: true
                          score: 0.85
                          reason: "User has strict budget constraint (500 TL)"
                          confidence: 0.85
                          priority: 1
                          factors:
                            budget_constraint: 0.9
                            price_sensitivity: 0.8
                        - name: "review_analysis"
                          selected: true
                          score: 0.78
                          reason: "User values quality and ratings"
                          confidence: 0.78
                          priority: 2
                          factors:
                            quality_preference: 0.85
                      category_matching:
                        - category_name: "Kitchen"
                          score: 0.85
                          reasons:
                            - "User hobby: cooking (0.9 match)"
                            - "Occasion: birthday (0.7 match)"
                            - "Age appropriate: 35 years (0.8 match)"
                          feature_contributions:
                            hobby_match: 0.45
                            occasion_fit: 0.30
                            age_appropriateness: 0.25
                      attention_weights: null
                      thinking_steps: []
                      confidence_explanation: null
                    inference_time: 1.25
                    cache_hit: false
                full_reasoning:
                  summary: Response with full reasoning (reasoning_level=full)
                  value:
                    recommendations:
                      - gift:
                          id: "12345"
                          name: "Premium Coffee Set"
                          category: "Kitchen & Dining"
                          price: 299.99
                          rating: 4.5
                          image_url: "https://cdn.trendyol.com/example.jpg"
                          trendyol_url: "https://www.trendyol.com/product/12345"
                          description: "High-quality coffee set"
                          tags: ["coffee", "kitchen", "gift"]
                          age_suitability: [25, 65]
                          occasion_fit: ["birthday", "anniversary"]
                          in_stock: true
                        confidence_score: 0.92
                        reasoning:
                          - "Perfect match for your hobbies: cooking"
                          - "Great value: Only 60% of your budget"
                          - "Highly rated: 4.5/5.0 stars"
                        tool_insights: {}
                        rank: 1
                    tool_results: {}
                    reasoning_trace:
                      tool_selection:
                        - name: "price_comparison"
                          selected: true
                          score: 0.85
                          reason: "User has strict budget constraint (500 TL)"
                          confidence: 0.85
                          priority: 1
                          factors:
                            budget_constraint: 0.9
                            price_sensitivity: 0.8
                      category_matching:
                        - category_name: "Kitchen"
                          score: 0.85
                          reasons:
                            - "User hobby: cooking (0.9 match)"
                            - "Occasion: birthday (0.7 match)"
                          feature_contributions:
                            hobby_match: 0.45
                            occasion_fit: 0.30
                      attention_weights:
                        user_features:
                          hobbies: 0.45
                          budget: 0.30
                          age: 0.15
                          occasion: 0.10
                        gift_features:
                          category: 0.40
                          price: 0.35
                          rating: 0.25
                      thinking_steps:
                        - step: 1
                          action: "Encode user profile"
                          result: "User encoding completed"
                          insight: "Strong cooking interest detected"
                        - step: 2
                          action: "Match categories"
                          result: "Top categories: Kitchen, Home, Dining"
                          insight: "Identified 3 relevant categories"
                        - step: 3
                          action: "Select tools"
                          result: "Selected tools: price_comparison, review_analysis"
                          insight: "Chose 2 tools for analysis"
                        - step: 4
                          action: "Execute tools"
                          result: "Executed 2 tools successfully"
                          insight: "Found 15 items in budget with good ratings"
                        - step: 5
                          action: "Rank gifts"
                          result: "Ranked top 5 gifts"
                          insight: "Selected gifts based on multi-criteria scoring"
                      confidence_explanation:
                        score: 0.92
                        level: "high"
                        factors:
                          positive:
                            - "Strong category match (0.85)"
                            - "Excellent reviews (4.5/5.0)"
                            - "Price within optimal budget range"
                          negative: []
                    inference_time: 1.30
                    cache_hit: false
        '400':
          description: Bad request - Invalid reasoning parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid_reasoning_level:
                  summary: Invalid reasoning_level parameter
                  value:
                    error_code: "INVALID_PARAMETER"
                    message: "GeÃ§ersiz reasoning_level deÄŸeri. GeÃ§erli deÄŸerler: basic, detailed, full"
                    details:
                      parameter: "reasoning_level"
                      provided_value: "invalid"
                      valid_values: ["basic", "detailed", "full"]
                    timestamp: "2024-01-15T10:30:00Z"
                    request_id: "abc-123"
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error_code: "VALIDATION_ERROR"
                message: "GeÃ§ersiz deÄŸer: age"
                details:
                  field: "age"
                  validation_errors:
                    - loc: ["body", "user_profile", "age"]
                      msg: "ensure this value is greater than or equal to 18"
                      type: "value_error.number.not_ge"
                timestamp: "2024-01-15T10:30:00Z"
                request_id: "abc-123"
        '500':
          description: Internal server error - Reasoning generation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                reasoning_generation_failed:
                  summary: Reasoning generation failed
                  value:
                    error_code: "REASONING_GENERATION_ERROR"
                    message: "Reasoning oluÅŸturma baÅŸarÄ±sÄ±z oldu, temel Ã¶neriler dÃ¶ndÃ¼rÃ¼lÃ¼yor"
                    details:
                      component: "ReasoningService"
                      fallback_applied: true
                      error_type: "attention_weights_extraction_failed"
                    timestamp: "2024-01-15T10:30:00Z"
                    request_id: "abc-123"
                reasoning_timeout:
                  summary: Reasoning generation timeout
                  value:
                    error_code: "REASONING_TIMEOUT"
                    message: "Reasoning oluÅŸturma zaman aÅŸÄ±mÄ±na uÄŸradÄ±, kÄ±smi sonuÃ§lar dÃ¶ndÃ¼rÃ¼lÃ¼yor"
                    details:
                      timeout_seconds: 5.0
                      partial_reasoning: true
                      missing_components: ["thinking_steps", "attention_weights"]
                    timestamp: "2024-01-15T10:30:00Z"
                    request_id: "abc-123"
        '503':
          description: Service unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error_code: "SERVICE_UNAVAILABLE"
                message: "Model ÅŸu anda kullanÄ±lamÄ±yor"
                timestamp: "2024-01-15T10:30:00Z"
                request_id: "abc-123"

  /api/v1/health:
    get:
      tags:
        - health
      summary: Health check
      description: Check system health status including model, API, and cache
      operationId: healthCheck
      responses:
        '200':
          description: Health status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              example:
                status: "healthy"
                model_loaded: true
                trendyol_api_status: "operational"
                cache_status: "connected"
                timestamp: "2024-01-15T10:30:00Z"

  /api/v1/metrics:
    get:
      tags:
        - metrics
      summary: Get Prometheus metrics
      description: Returns metrics in Prometheus exposition format
      operationId: getMetrics
      responses:
        '200':
          description: Prometheus metrics
          content:
            text/plain:
              schema:
                type: string
              example: |
                # HELP recommendation_requests_total Total recommendation requests
                # TYPE recommendation_requests_total counter
                recommendation_requests_total 1234
                
                # HELP inference_duration_seconds Model inference duration
                # TYPE inference_duration_seconds histogram
                inference_duration_seconds_bucket{le="0.5"} 100
                inference_duration_seconds_bucket{le="1.0"} 250

  /api/v1/resources:
    get:
      tags:
        - health
      summary: Get system resources
      description: Returns CPU, memory, and GPU usage
      operationId: getResources
      responses:
        '200':
          description: Resource metrics
          content:
            application/json:
              schema:
                type: object
                properties:
                  cpu_percent:
                    type: number
                    format: float
                  memory_percent:
                    type: number
                    format: float
                  memory_used_mb:
                    type: number
                    format: float
                  memory_total_mb:
                    type: number
                    format: float
                  gpu_available:
                    type: boolean
                  gpu_memory_used_mb:
                    type: number
                    format: float
                  gpu_memory_total_mb:
                    type: number
                    format: float
              example:
                cpu_percent: 45.2
                memory_percent: 62.8
                memory_used_mb: 2048
                memory_total_mb: 8192
                gpu_available: true
                gpu_memory_used_mb: 1024
                gpu_memory_total_mb: 4096

  /api/v1/tools/stats:
    get:
      tags:
        - tools
      summary: Get tool statistics
      description: Returns usage statistics for all analysis tools
      operationId: getToolStats
      responses:
        '200':
          description: Tool statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ToolStatsResponse'
              example:
                tool_usage:
                  price_comparison: 1234
                  review_analysis: 1150
                  trend_analysis: 980
                success_rates:
                  price_comparison: 0.95
                  review_analysis: 0.92
                  trend_analysis: 0.88
                average_execution_times:
                  price_comparison: 0.45
                  review_analysis: 0.82
                  trend_analysis: 0.65

components:
  schemas:
    UserProfile:
      type: object
      required:
        - age
        - hobbies
        - relationship
        - budget
        - occasion
      properties:
        age:
          type: integer
          minimum: 18
          maximum: 100
          description: Age of the gift recipient
          example: 35
        hobbies:
          type: array
          items:
            type: string
          minItems: 1
          maxItems: 10
          description: List of hobbies
          example: ["cooking", "gardening"]
        relationship:
          type: string
          description: Relationship to the recipient
          example: "mother"
        budget:
          type: number
          format: float
          minimum: 0
          exclusiveMinimum: true
          description: Budget in Turkish Lira
          example: 500.0
        occasion:
          type: string
          description: Special occasion
          example: "birthday"
        personality_traits:
          type: array
          items:
            type: string
          maxItems: 5
          description: Personality traits
          example: ["practical", "eco-friendly"]

    GiftItem:
      type: object
      required:
        - id
        - name
        - category
        - price
        - rating
        - image_url
        - trendyol_url
      properties:
        id:
          type: string
          description: Unique product identifier
          example: "12345"
        name:
          type: string
          description: Product name
          example: "Premium Coffee Set"
        category:
          type: string
          description: Product category
          example: "Kitchen & Dining"
        price:
          type: number
          format: float
          minimum: 0
          description: Product price in TL
          example: 299.99
        rating:
          type: number
          format: float
          minimum: 0
          maximum: 5
          description: Product rating
          example: 4.5
        image_url:
          type: string
          format: uri
          description: Product image URL
          example: "https://cdn.trendyol.com/example.jpg"
        trendyol_url:
          type: string
          format: uri
          description: Trendyol product page URL
          example: "https://www.trendyol.com/product/12345"
        description:
          type: string
          description: Product description
          example: "High-quality coffee set"
        tags:
          type: array
          items:
            type: string
          description: Product tags
          example: ["coffee", "kitchen", "gift"]
        age_suitability:
          type: array
          items:
            type: integer
          minItems: 2
          maxItems: 2
          description: Age range suitability
          example: [25, 65]
        occasion_fit:
          type: array
          items:
            type: string
          description: Suitable occasions
          example: ["birthday", "anniversary"]
        in_stock:
          type: boolean
          description: Stock availability
          example: true

    GiftRecommendation:
      type: object
      required:
        - gift
        - confidence_score
        - reasoning
        - rank
      properties:
        gift:
          $ref: '#/components/schemas/GiftItem'
        confidence_score:
          type: number
          format: float
          minimum: 0
          maximum: 1
          description: Confidence score
          example: 0.92
        reasoning:
          type: array
          items:
            type: string
          description: Reasoning for recommendation
          example: ["Matches user's cooking hobby", "Within budget range"]
        tool_insights:
          type: object
          description: Insights from analysis tools
          additionalProperties: true
        rank:
          type: integer
          minimum: 1
          description: Recommendation rank
          example: 1

    RecommendationRequest:
      type: object
      required:
        - user_profile
      properties:
        user_profile:
          $ref: '#/components/schemas/UserProfile'
        max_recommendations:
          type: integer
          minimum: 1
          maximum: 20
          default: 5
          description: Maximum number of recommendations
          example: 5
        use_cache:
          type: boolean
          default: true
          description: Whether to use cache
          example: true

    RecommendationResponse:
      type: object
      required:
        - recommendations
        - inference_time
        - cache_hit
      properties:
        recommendations:
          type: array
          items:
            $ref: '#/components/schemas/GiftRecommendation'
        tool_results:
          type: object
          description: Aggregated tool results
          additionalProperties: true
        inference_time:
          type: number
          format: float
          description: Inference time in seconds
          example: 1.23
        cache_hit:
          type: boolean
          description: Whether result was from cache
          example: false

    ToolSelectionReasoning:
      type: object
      required:
        - name
        - selected
        - score
        - reason
        - confidence
        - priority
      properties:
        name:
          type: string
          description: Tool name (e.g., price_comparison, review_analysis)
          example: "price_comparison"
        selected:
          type: boolean
          description: Whether this tool was selected for execution
          example: true
        score:
          type: number
          format: float
          minimum: 0
          maximum: 1
          description: Tool selection score from model
          example: 0.85
        reason:
          type: string
          description: Human-readable explanation for why tool was/wasn't selected
          example: "User has strict budget constraint (500 TL)"
        confidence:
          type: number
          format: float
          minimum: 0
          maximum: 1
          description: Confidence in the tool selection decision
          example: 0.85
        priority:
          type: integer
          minimum: 1
          description: Priority order for selected tools (1 = highest priority)
          example: 1
        factors:
          type: object
          description: Contributing factors with their weights
          additionalProperties:
            type: number
            format: float
          example:
            budget_constraint: 0.9
            price_sensitivity: 0.8

    CategoryMatchingReasoning:
      type: object
      required:
        - category_name
        - score
        - reasons
        - feature_contributions
      properties:
        category_name:
          type: string
          description: Name of the gift category
          example: "Kitchen"
        score:
          type: number
          format: float
          minimum: 0
          maximum: 1
          description: Category match score
          example: 0.85
        reasons:
          type: array
          items:
            type: string
          description: List of reasons explaining the category match
          example:
            - "User hobby: cooking (0.9 match)"
            - "Occasion: birthday (0.7 match)"
            - "Age appropriate: 35 years (0.8 match)"
        feature_contributions:
          type: object
          description: Contribution weight of each feature to the category score
          additionalProperties:
            type: number
            format: float
          example:
            hobby_match: 0.45
            occasion_fit: 0.30
            age_appropriateness: 0.25

    AttentionWeights:
      type: object
      required:
        - user_features
        - gift_features
      properties:
        user_features:
          type: object
          description: |
            Attention weights for user profile features.
            Shows how much the model focused on each user attribute.
            Weights sum to 1.0.
          additionalProperties:
            type: number
            format: float
            minimum: 0
            maximum: 1
          example:
            hobbies: 0.45
            budget: 0.30
            age: 0.15
            occasion: 0.10
        gift_features:
          type: object
          description: |
            Attention weights for gift features.
            Shows how much the model focused on each gift attribute.
            Weights sum to 1.0.
          additionalProperties:
            type: number
            format: float
            minimum: 0
            maximum: 1
          example:
            category: 0.40
            price: 0.35
            rating: 0.25

    ThinkingStep:
      type: object
      required:
        - step
        - action
        - result
        - insight
      properties:
        step:
          type: integer
          minimum: 1
          description: Step number in the thinking process
          example: 1
        action:
          type: string
          description: Action performed in this step
          example: "Encode user profile"
        result:
          type: string
          description: Result of the action
          example: "User encoding completed"
        insight:
          type: string
          description: Insight or observation from this step
          example: "Strong cooking interest detected"

    ConfidenceExplanation:
      type: object
      required:
        - score
        - level
        - factors
      properties:
        score:
          type: number
          format: float
          minimum: 0
          maximum: 1
          description: Confidence score
          example: 0.85
        level:
          type: string
          enum: [high, medium, low]
          description: |
            Confidence level classification:
            - high: score > 0.8
            - medium: 0.5 <= score <= 0.8
            - low: score < 0.5
          example: "high"
        factors:
          type: object
          description: Factors affecting confidence
          required:
            - positive
            - negative
          properties:
            positive:
              type: array
              items:
                type: string
              description: Factors that increase confidence
              example:
                - "Strong category match (0.85)"
                - "Excellent reviews (4.5/5.0)"
                - "Price within optimal budget range"
            negative:
              type: array
              items:
                type: string
              description: Factors that decrease confidence
              example:
                - "Slightly above typical budget"

    ReasoningTrace:
      type: object
      description: |
        Complete reasoning trace explaining the model's decision-making process.
        
        Content varies by reasoning_level:
        - basic: Empty (null)
        - detailed: tool_selection + category_matching
        - full: All fields populated
      properties:
        tool_selection:
          type: array
          items:
            $ref: '#/components/schemas/ToolSelectionReasoning'
          description: Reasoning for each tool selection decision
        category_matching:
          type: array
          items:
            $ref: '#/components/schemas/CategoryMatchingReasoning'
          description: Reasoning for category matching
        attention_weights:
          allOf:
            - $ref: '#/components/schemas/AttentionWeights'
          nullable: true
          description: Attention weights (only in full reasoning level)
        thinking_steps:
          type: array
          items:
            $ref: '#/components/schemas/ThinkingStep'
          description: Step-by-step thinking process (only in full reasoning level)
        confidence_explanation:
          allOf:
            - $ref: '#/components/schemas/ConfidenceExplanation'
          nullable: true
          description: Explanation of confidence score (optional)

    EnhancedGiftRecommendation:
      allOf:
        - $ref: '#/components/schemas/GiftRecommendation'
        - type: object
          properties:
            reasoning_trace:
              allOf:
                - $ref: '#/components/schemas/ReasoningTrace'
              nullable: true
              description: Detailed reasoning trace for this specific recommendation

    EnhancedRecommendationResponse:
      type: object
      required:
        - recommendations
        - tool_results
        - inference_time
        - cache_hit
      properties:
        recommendations:
          type: array
          items:
            $ref: '#/components/schemas/EnhancedGiftRecommendation'
          description: List of gift recommendations with optional reasoning
        tool_results:
          type: object
          description: Aggregated tool execution results
          additionalProperties: true
        reasoning_trace:
          allOf:
            - $ref: '#/components/schemas/ReasoningTrace'
          nullable: true
          description: |
            Overall reasoning trace for the recommendation process.
            
            - null when include_reasoning=false
            - Populated based on reasoning_level when include_reasoning=true
        inference_time:
          type: number
          format: float
          description: Total inference time in seconds (including reasoning generation)
          example: 1.25
        cache_hit:
          type: boolean
          description: Whether result was retrieved from cache
          example: false

    HealthResponse:
      type: object
      required:
        - status
        - model_loaded
        - trendyol_api_status
        - cache_status
        - timestamp
      properties:
        status:
          type: string
          enum: [healthy, degraded, unhealthy]
          description: Overall system status
          example: "healthy"
        model_loaded:
          type: boolean
          description: Whether model is loaded
          example: true
        trendyol_api_status:
          type: string
          enum: [operational, degraded, down]
          description: Trendyol API status
          example: "operational"
        cache_status:
          type: string
          enum: [connected, disconnected]
          description: Cache connection status
          example: "connected"
        timestamp:
          type: string
          format: date-time
          description: Timestamp of health check
          example: "2024-01-15T10:30:00Z"

    ToolStatsResponse:
      type: object
      required:
        - tool_usage
        - success_rates
        - average_execution_times
      properties:
        tool_usage:
          type: object
          additionalProperties:
            type: integer
          description: Number of times each tool was used
        success_rates:
          type: object
          additionalProperties:
            type: number
            format: float
          description: Success rate for each tool (0-1)
        average_execution_times:
          type: object
          additionalProperties:
            type: number
            format: float
          description: Average execution time in seconds

    ErrorResponse:
      type: object
      required:
        - error_code
        - message
        - timestamp
        - request_id
      properties:
        error_code:
          type: string
          description: Error code
          example: "VALIDATION_ERROR"
        message:
          type: string
          description: Error message
          example: "GeÃ§ersiz deÄŸer: age"
        details:
          type: object
          description: Additional error details
          additionalProperties: true
        timestamp:
          type: string
          format: date-time
          description: Error timestamp
          example: "2024-01-15T10:30:00Z"
        request_id:
          type: string
          description: Unique request identifier
          example: "abc-123"

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT authentication (to be implemented)

security: []
