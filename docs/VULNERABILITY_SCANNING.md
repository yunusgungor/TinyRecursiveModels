# Vulnerability Scanning Guide

## Overview

This guide explains how to scan Docker images and dependencies for security vulnerabilities using Trivy. Regular vulnerability scanning is essential for maintaining secure container infrastructure.

## Why Vulnerability Scanning?

Vulnerability scanning helps:
- **Identify known security issues** in dependencies and base images
- **Prevent deployment** of vulnerable code to production
- **Maintain compliance** with security standards
- **Detect secrets** accidentally committed to repositories
- **Find misconfigurations** in Docker images

## Trivy Scanner

We use [Trivy](https://aquasecurity.github.io/trivy/) for vulnerability scanning because it:
- Scans OS packages and application dependencies
- Detects secrets in images and repositories
- Finds misconfigurations in Dockerfiles and Kubernetes manifests
- Supports multiple output formats (table, JSON, SARIF)
- Integrates easily with CI/CD pipelines
- Is fast and accurate

## Installation

### macOS

```bash
brew install aquasecurity/trivy/trivy
```

### Linux (Debian/Ubuntu)

```bash
wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
sudo apt-get update
sudo apt-get install trivy
```

### Linux (RHEL/CentOS)

```bash
sudo rpm -ivh https://github.com/aquasecurity/trivy/releases/download/v0.48.0/trivy_0.48.0_Linux-64bit.rpm
```

### Docker

```bash
docker pull aquasec/trivy:latest
```

## Local Scanning

### Quick Scan

Use the provided script to scan all components:

```bash
./scripts/scan-vulnerabilities.sh
```

### Scan Options

```bash
# Scan only Docker images
./scripts/scan-vulnerabilities.sh --images-only

# Scan only dependencies
./scripts/scan-vulnerabilities.sh --deps-only

# Scan only for secrets
./scripts/scan-vulnerabilities.sh --secrets-only

# Fail on critical vulnerabilities
./scripts/scan-vulnerabilities.sh --fail-on-critical
```

### Manual Scanning

#### Scan Docker Image

```bash
# Scan for vulnerabilities
trivy image backend:latest

# Scan with specific severity
trivy image --severity CRITICAL,HIGH backend:latest

# Scan and output JSON
trivy image --format json --output results.json backend:latest

# Scan for secrets
trivy image --scanners secret backend:latest

# Scan for misconfigurations
trivy image --scanners config backend:latest
```

#### Scan Dependencies

```bash
# Scan backend dependencies
trivy fs ./backend

# Scan frontend dependencies
trivy fs ./frontend

# Scan specific file
trivy fs requirements.txt
trivy fs package.json
```

#### Scan Repository for Secrets

```bash
# Scan entire repository
trivy fs --scanners secret .

# Scan specific directory
trivy fs --scanners secret ./backend
```

## CI/CD Integration

### GitHub Actions

We have automated security scanning in `.github/workflows/security-scan.yml`:

```yaml
- name: Run Trivy vulnerability scanner
  uses: aquasecurity/trivy-action@master
  with:
    image-ref: 'backend:latest'
    format: 'sarif'
    output: 'trivy-results.sarif'
    severity: 'CRITICAL,HIGH,MEDIUM'
    exit-code: '1'  # Fail build on vulnerabilities
```

The workflow:
- Runs on every push and pull request
- Scans backend and frontend images
- Scans dependencies
- Scans repository for secrets
- Uploads results to GitHub Security tab
- Fails build on critical vulnerabilities

### GitLab CI

```yaml
security_scan:
  image: aquasec/trivy:latest
  script:
    - trivy image --exit-code 1 --severity CRITICAL,HIGH $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
  only:
    - main
    - develop
```

### Jenkins

```groovy
stage('Security Scan') {
    steps {
        sh 'trivy image --exit-code 1 --severity CRITICAL,HIGH myapp:latest'
    }
}
```

## Scan Types

### 1. Vulnerability Scanning

Scans for known CVEs in:
- OS packages (apt, yum, apk)
- Application dependencies (pip, npm, gem, etc.)
- Base images

```bash
trivy image --severity CRITICAL,HIGH,MEDIUM backend:latest
```

### 2. Secret Scanning

Detects accidentally committed secrets:
- API keys
- Passwords
- Tokens
- Private keys
- AWS credentials

```bash
trivy fs --scanners secret .
```

### 3. Misconfiguration Scanning

Finds security misconfigurations:
- Running as root
- Exposed ports
- Insecure settings
- Missing security headers

```bash
trivy image --scanners config backend:latest
```

### 4. License Scanning

Identifies license compliance issues:

```bash
trivy image --scanners license backend:latest
```

## Severity Levels

Trivy categorizes vulnerabilities by severity:

| Severity | Description | Action |
|----------|-------------|--------|
| CRITICAL | Actively exploited, high impact | Fix immediately |
| HIGH | Serious security risk | Fix within 7 days |
| MEDIUM | Moderate security risk | Fix within 30 days |
| LOW | Minor security risk | Fix when convenient |
| UNKNOWN | Severity not determined | Investigate |

## Handling Vulnerabilities

### 1. Update Dependencies

Most vulnerabilities can be fixed by updating dependencies:

```bash
# Python
pip install --upgrade package-name

# Node.js
npm update package-name
```

### 2. Update Base Images

Keep base images up to date:

```dockerfile
# Update to latest patch version
FROM python:3.10-slim  # Instead of python:3.10.0-slim

# Or use specific secure version
FROM python:3.10.13-slim
```

### 3. Ignore False Positives

Create `.trivyignore` file to ignore false positives:

```
# Ignore specific CVE
CVE-2023-12345

# Ignore CVE in specific package
CVE-2023-12345 python-package

# Ignore with expiration
CVE-2023-12345 exp:2024-12-31
```

### 4. Accept Risk

Document accepted risks in `SECURITY.md`:

```markdown
## Accepted Risks

### CVE-2023-12345
- **Severity**: MEDIUM
- **Package**: example-package
- **Reason**: Not exploitable in our use case
- **Mitigation**: Input validation implemented
- **Review Date**: 2024-01-01
```

## Best Practices

### DO:
✅ Scan images before deployment
✅ Scan on every commit in CI/CD
✅ Fix critical vulnerabilities immediately
✅ Keep dependencies up to date
✅ Use minimal base images (alpine, slim)
✅ Scan for secrets regularly
✅ Review scan results in security tab
✅ Document accepted risks

### DON'T:
❌ Ignore critical vulnerabilities
❌ Deploy images with known exploits
❌ Disable security scanning
❌ Use outdated base images
❌ Commit secrets to repository
❌ Skip dependency updates
❌ Ignore scan failures in CI/CD

## Automated Scanning Schedule

### Daily Scans

Run automated scans daily to catch new vulnerabilities:

```yaml
on:
  schedule:
    - cron: '0 2 * * *'  # 2 AM UTC daily
```

### On Dependency Updates

Scan when dependencies change:

```yaml
on:
  push:
    paths:
      - 'requirements.txt'
      - 'package.json'
      - 'Dockerfile'
```

## Integration with GitHub Security

Scan results are automatically uploaded to GitHub Security tab:

1. Navigate to **Security** → **Code scanning alerts**
2. View vulnerabilities by severity
3. See affected files and remediation advice
4. Track fix status

## Reporting

### Generate Reports

```bash
# HTML report
trivy image --format template --template "@contrib/html.tpl" \
  --output report.html backend:latest

# JSON report
trivy image --format json --output report.json backend:latest

# SARIF report (for GitHub)
trivy image --format sarif --output report.sarif backend:latest
```

### View Reports

```bash
# Open HTML report
open report.html  # macOS
xdg-open report.html  # Linux
```

## Troubleshooting

### Scan Takes Too Long

```bash
# Skip database update
trivy image --skip-db-update backend:latest

# Use cache
trivy image --cache-dir /tmp/trivy backend:latest
```

### False Positives

```bash
# Ignore specific vulnerabilities
echo "CVE-2023-12345" >> .trivyignore
trivy image backend:latest
```

### Network Issues

```bash
# Use offline mode (requires pre-downloaded DB)
trivy image --offline-scan backend:latest

# Use custom registry
trivy image --registry-token $TOKEN backend:latest
```

## Advanced Configuration

### Custom Policy

Create `trivy-policy.rego` for custom rules:

```rego
package trivy

deny[msg] {
    input.Vulnerabilities[_].Severity == "CRITICAL"
    msg := "Critical vulnerability found"
}
```

Use with:

```bash
trivy image --policy trivy-policy.rego backend:latest
```

### Custom Templates

Create custom output templates:

```bash
trivy image --format template --template "@mytemplate.tpl" backend:latest
```

## Compliance

### CIS Benchmarks

Scan against CIS Docker Benchmark:

```bash
trivy image --compliance docker-cis backend:latest
```

### NIST

Scan for NIST compliance:

```bash
trivy image --compliance nist backend:latest
```

## Monitoring and Alerting

### Prometheus Metrics

Export scan results as Prometheus metrics:

```bash
trivy image --format json backend:latest | \
  jq '.Results[].Vulnerabilities | length' | \
  prometheus_pushgateway
```

### Slack Notifications

Send scan results to Slack:

```bash
trivy image --format json backend:latest | \
  jq -r '.Results[].Vulnerabilities[] | select(.Severity=="CRITICAL")' | \
  slack-notify
```

## Resources

- [Trivy Documentation](https://aquasecurity.github.io/trivy/)
- [CVE Database](https://cve.mitre.org/)
- [National Vulnerability Database](https://nvd.nist.gov/)
- [GitHub Security Advisories](https://github.com/advisories)
- [Snyk Vulnerability Database](https://snyk.io/vuln/)

## Example Workflow

1. **Develop**: Write code with dependencies
2. **Commit**: Push to repository
3. **CI Scan**: Automated scan runs
4. **Review**: Check scan results
5. **Fix**: Update vulnerable dependencies
6. **Verify**: Re-scan to confirm fix
7. **Deploy**: Deploy secure image

## Security Policy

See `SECURITY.md` for:
- Vulnerability disclosure policy
- Security update schedule
- Contact information
- Supported versions
