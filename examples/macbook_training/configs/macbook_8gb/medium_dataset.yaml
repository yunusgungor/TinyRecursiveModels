# MacBook 8GB RAM - Medium Dataset Configuration
# Optimized for datasets 100MB - 1GB on MacBooks with 8GB RAM

defaults:
  - arch: trm
  - _self_

# MacBook hardware profile
hardware_profile: "macbook_8gb"
expected_ram_gb: 8
expected_cpu_cores: 4

# Data configuration
data_paths: ['data/medium-dataset']
data_paths_test: []

# Memory-constrained training parameters for medium datasets
global_batch_size: 24  # Smaller batch size for larger datasets
effective_batch_size: 96  # Achieved through gradient accumulation

# Training configuration optimized for 8GB RAM + medium dataset
epochs: 2000  # Required field at top level
training:
  eval_interval: 200
  checkpoint_every_eval: true
  
  # Aggressive memory management
  memory_limit_mb: 3500  # More conservative for larger datasets
  gradient_accumulation_steps: 4
  max_sequence_length: 256
  
  # CPU optimization
  num_workers: 1  # Reduced for memory constraints
  pin_memory: false
  enable_cpu_optimization: true
  torch_threads: 4
  
  # Checkpoint management
  checkpoint_interval: 300
  max_checkpoints_to_keep: 2
  
  # Progress monitoring
  monitoring_interval: 10.0  # Less frequent monitoring
  enable_thermal_monitoring: true

# Learning rate optimized for medium datasets
lr: 1.5e-4
lr_min_ratio: 0.1
lr_warmup_steps: 200

# Regularization
beta1: 0.9
beta2: 0.95
weight_decay: 0.08
puzzle_emb_weight_decay: 0.08

# Puzzle embedding training
puzzle_emb_lr: 3e-3

# Model architecture for medium datasets on 8GB RAM
arch:
  # Required fields
  name: "trm"
  loss:
    name: "cross_entropy"
  
  # Balanced model size
  hidden_size: 256
  num_heads: 8
  L_layers: 2
  expansion: 2
  
  # Moderate recursive reasoning
  H_cycles: 2
  L_cycles: 3
  halt_max_steps: 6
  halt_exploration_prob: 0.1
  
  # Memory-efficient settings
  forward_dtype: "float32"
  embed_scale: true
  init_std: 0.8
  
  # Sequence parameters
  seq_len: 256
  batch_size: 6  # Reduced physical batch size
  
  # RMS norm parameters
  rms_norm_eps: 1e-5

# Evaluators
evaluators:
  - name: arc@ARC

# System settings
seed: 42
min_eval_interval: 0
ema: false
freeze_weights: false

# Logging
use_wandb: false
log_interval: 100

# Output configuration
output_dir: "outputs/macbook_8gb_medium"
experiment_name: "trm_medium_8gb"

# MacBook-specific optimizations for medium datasets
macbook_optimizations:
  # Aggressive memory management
  enable_memory_monitoring: true
  memory_pressure_threshold: 70.0  # More aggressive threshold
  dynamic_batch_sizing: true
  auto_garbage_collection: true
  force_gc_interval: 50  # Force GC every 50 batches
  
  # CPU optimization
  use_mkl: true
  optimize_tensor_operations: true
  enable_vectorization: true
  
  # Dataset management - streaming mode likely
  streaming_threshold_mb: 100.0
  cache_threshold_mb: 50.0
  chunk_size_mb: 20.0
  enable_caching: false  # Disabled for memory constraints
  auto_fallback_streaming: true
  force_streaming_mode: true  # Force streaming for medium datasets
  
  # Thermal management
  thermal_throttle_threshold: 80.0  # Lower threshold
  cooling_delay_seconds: 3.0
  
  # Progress reporting
  show_resource_usage: true
  show_eta: true
  show_samples_per_second: true
  memory_warning_threshold: 65.0